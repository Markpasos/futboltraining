<!DOCTYPE html>
<html lang="es">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adapter.js/8.1.1/adapter.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador de Entrenamientos de Fútbol</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f0f0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .welcome-screen {
            padding: 40px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #219653;
        }
        
        .btn-secondary {
            background-color: #3498db;
        }
        
        .btn-secondary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .editor-screen {
            display: none;
        }
        
        .field-container {
            width: 100%; /* Ocupa el ancho disponible */
            max-width: 800px; /* Máximo ancho (opcional) */
            aspect-ratio: 16/9; /* Relación de aspecto (ajusta según tu diseño) */
            margin: 0 auto; /* Centrado */
            position: relative; /* Para posicionar elementos hijos */
            overflow: hidden; /* Evita que los elementos se salgan */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA4MDAgNTAwIj48ZGVmcz48cGF0dGVybiBpZD0iZ3Jhc3MiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCI+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjEwIiBmaWxsPSIjMzhjNzU5Ii8+PHBhdGggZD0iTTAgMEwxMCAxME0xMCAwTDAgMTAiIHN0cm9rZT0iIzQyZDg2MCIgc3Ryb2tlLXdpZHRoPSIwLjUiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSI4MDAiIGhlaWdodD0iNTAwIiBmaWxsPSJ1cmwoI2dyYXNzKSIvPjxyZWN0IHg9IjQwIiB5PSI0MCIgd2lkdGg9IjcyMCIgaGVpZ2h0PSI0MjAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPjxjaXJjbGUgY3g9IjQwMCIgY3k9IjI1MCIgcj0iNjAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPjxsaW5lIHgxPSI0MDAiIHkxPSI0MCIgeDI9IjQwMCIgeTI9IjQ2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIi8+PHJlY3QgeD0iNDAiIHk9IjE3NSIgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxNTAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPjxyZWN0IHg9IjY2MCIgeT0iMTc1IiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjE1MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+PHJlY3QgeD0iNDAiIHk9IjIwMCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjEwMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIzIiBmaWxsPSJub25lIi8+PHJlY3QgeD0iNzIwIiB5PSIyMDAiIHdpZHRoPSI0MCIgaGVpZ2h0PSIxMDAiIHN0cm9rZT0id2hpdGUiIHN0cm9rZS13aWR0aD0iMyIgZmlsbD0ibm9uZSIvPjxjaXJjbGUgY3g9IjExMCIgY3k9IjI1MCIgcj0iMyIgZmlsbD0id2hpdGUiLz48Y2lyY2xlIGN4PSI2OTAiIGN5PSIyNTAiIHI9IjMiIGZpbGw9IndoaXRlIi8+PC9zdmc+');
            background-size: cover;
            background-position: center;
            border: 3px solid #2c3e50;
            border-radius: 5px;
        }

        .tools-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .tools-container .tool[data-type="ball"],
        .tools-container .tool[data-type="cone"] {
            width: 50px;
            height: 50px;
        }
        .field-container .element[data-type="ball"],
        .field-container .element[data-type="cone"] {
            width: 25px;  /* Tamaño reducido */
            height: 25px;
        }
        .tool {
            width: 50px;
            height: 50px;
            cursor: grab;
            user-select: none;
        }
        
        .element {
            position: absolute;
            width: 40px;
            height: 40px;
            cursor: move;
            user-select: none;
            z-index: 10;
            touch-action: none
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .sequence-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .sequence-tabs {
            display: flex;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .sequence-tab {
            padding: 8px 15px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .sequence-tab.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        .sequence-log {
        margin-top: 15px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        max-height: 150px;
        overflow-y: auto;
        font-size: 0.9em;
        }

        .log-entry {
            padding: 5px;
            margin: 3px 0;
            background-color: #e9ecef;
            border-radius: 3px;
        }

        .current-sequence {
            background-color: #cfe2ff;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
            
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 80%;
        }
        
        .modal h2 {
            margin-bottom: 15px;
        }
        
        .saved-activities {
            text-align: left;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .activity-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        
        .activity-item:hover {
            background-color: #f5f5f5;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        @media (max-width: 600px) {
        .tool {
            width: 70px;
            height: 70px;
            margin: 12px;
        }
        @media (max-width: 600px) {
            .field-container {
                height: 60vh; /* Altura adaptable en móviles */
                touch-action: none; /* Evita el zoom no deseado */
            }
            .element {
                width: 30px !important; /* Tamaño fijo en móviles */
                height: 30px !important;
            }
        }
        .element {
            width: 50px;
            height: 50px;
        }
    }

    .color-picker {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    #playerColor {
        width: 50px;
        height: 50px;
        border: none;
        cursor: pointer;
    }

    /* Tamaño reducido para pelota y cono en campo */
    .field-container .element[data-type="ball"],
    .field-container .element[data-type="cone"] {
        width: 25px;
        height: 25px;
    }
        .tool {
            width: 45px;
            height: 45px;
            touch-action: none;
        }
        
        .field-container {
            height: 60vh;
            touch-action: none;
        }
        
        .modal-content {
            width: 95%;
            padding: 15px;
        }
        
        .element {
            width: 35px;
            height: 35px;
            touch-action: none;
        }

    /* Prevent zoom on touch */
    input, textarea, select, button {
        font-size: 16px;
}
    </style>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://recordrtc.org/latest.js"></script>
</head>
<body>
    <div class="container">
        <div class="welcome-screen" id="welcomeScreen">
            <h1>Planificador de Entrenamientos de Fútbol</h1>
            <p>Crea y guarda tus rutinas de entrenamiento de forma visual</p>
            <button class="btn" id="btnNewActivity">Comenzar Actividad</button>
            <button class="btn btn-secondary" id="btnLoadActivity">Cargar Actividad Anterior</button>
        </div>
        
        <div class="editor-screen" id="editorScreen">
            <h1>Editor de Actividades</h1>

            <div class="field-container" id="fieldContainer"></div>
            <div class="tools-container">
                <img src="./pelota.png" class="tool" data-type="ball" alt="Pelota">
                <img src="./cono.png" class="tool" data-type="cone" alt="Cono">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PGNpcmNsZSBjeD0iMjUiIGN5PSIxNSIgcj0iMTAiIGZpbGw9IiMzNDk4ZGIiLz48cGF0aCBkPSJNMjUgMjVjLTcuNSAwLTE1IDMtMTUgOHYxMmgzMFYzM2MwLTUtNy41LTgtMTUtOHoiIGZpbGw9IiMzNDk4ZGIiLz48L3N2Zz4=" class="tool" data-type="player" alt="Jugador" id="playerTool">
                <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MCA1MCI+PHJlY3QgeD0iMTAiIHk9IjEwIiB3aWR0aD0iMzAiIGhlaWdodD0iMzAiIGZpbGw9IiMyN2FlNjAiLz48L3N2Zz4=" 
                     class="tool" data-type="marker" alt="Marcador">
            </div>
            
            <!-- Selector de color -->
            <div class="color-picker" id="colorPicker" style="display: none;">
                <input type="color" id="playerColor" value="#3498db">
                <button class="btn" id="confirmColor">Crear Jugador</button>
            </div>
            
            <div class="controls">
                <button class="btn" id="btnAddSequence">Nueva Secuencia</button>
                <button class="btn btn-secondary" id="btnPlaySequence">Reproducir Secuencias</button>
                <button class="btn btn-secondary" id="btnRecordSequence">Grabar Video</button>
                <button class="btn" id="btnSaveActivity">Guardar Actividad</button>
                <button class="btn btn-danger" id="btnBackToMenu">Volver al Menú</button>
                <button class="btn btn-danger" id="btnDeleteSequence">Eliminar Secuencia</button>
                <button class="btn btn-secondary" id="btnSaveFile">Guardar como Archivo</button>
                <button class="btn btn-secondary" id="btnLoadFile">Cargar Archivo</button>
                <button class="btn btn-secondary" id="btnSaveSequence">Guardar Secuencia</button>
            </div>
            
            <div class="sequence-panel">
                <h3>Secuencias</h3>
                <div class="sequence-tabs" id="sequenceTabs">
                    <div class="sequence-tab active" data-sequence="1">Secuencia 1</div>
                </div>
                <div class="sequence-log" id="sequenceLog">
                    <div class="log-entry current-sequence">Secuencia 1: Edición actual</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para guardar actividad -->
    <div class="modal" id="saveModal">
        <div class="modal-content">
            <h2>Guardar Actividad</h2>
            <input type="text" id="activityName" placeholder="Nombre de la actividad">
            <div class="controls">
                <button class="btn" id="btnConfirmSave">Guardar</button>
                <button class="btn btn-danger" id="btnCancelSave">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para cargar actividad -->
    <div class="modal" id="loadModal">
        <div class="modal-content">
            <h2>Cargar Actividad</h2>
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <div class="saved-activities" id="savedActivitiesList">
                <!-- Las actividades guardadas se cargarán aquí -->
            </div>
            <div class="controls">
                <button class="btn btn-danger" id="btnCancelLoad">Cancelar</button>
                
            </div>
        </div>
    </div>
    
    <script>
        let currentSequence = 1;
        let sequences = { 1: { elements: {} } };
        let elements = [];
        let elementCounter = 0;
        let isDragging = false;
        let selectedElement = null;
        let selectedElementId = null;
        let offsetX, offsetY;
        let isAnimating = false;
        let mediaRecorder;
        let recordedChunks = [];
        let selectedPlayerType = null;
        let isSelectingColor = false;
        const welcomeScreen = document.getElementById('welcomeScreen');
        const editorScreen = document.getElementById('editorScreen');
        let fieldContainer;
        const sequenceTabs = document.getElementById('sequenceTabs');
        const saveModal = document.getElementById('saveModal');
        const loadModal = document.getElementById('loadModal');
        const savedActivitiesList = document.getElementById('savedActivitiesList');

        //Inicialización de Eventos (DOMContentLoaded)
        
        document.addEventListener('DOMContentLoaded', () => {
            // Verificación de librerías
            if (typeof RecordRTC === 'undefined') {
                console.error('RecordRTC no está cargado');
                alert('Error: No se cargaron correctamente las librerías necesarias. Recarga la página.');
            }
            if (typeof html2canvas === 'undefined') {
                console.error('html2canvas no está cargado');
                alert('Error: Falta la librería html2canvas. Recarga la página.');
            }

            // Eventos de la pantalla de bienvenida
            document.getElementById('btnNewActivity').addEventListener('click', startNewActivity);
            document.getElementById('btnLoadActivity').addEventListener('click', showLoadModal);
            document.getElementById('btnCancelLoad').addEventListener('click', function() {
                // Cerrar el modal de carga
                document.getElementById('loadModal').style.display = 'none';
            });


            // Eventos del editor
            document.getElementById('btnAddSequence').addEventListener('click', addSequence);
            document.getElementById('btnPlaySequence').addEventListener('click', async function() {
                if (confirm('¿Desea grabar un video de la secuencia? (Cancelar para solo reproducir)')) {
                    await recordSequence();
                } else {
                    await playAllSequences();
                }
            });
            document.getElementById('btnRecordSequence').addEventListener('click', recordSequence);
            document.getElementById('btnSaveActivity').addEventListener('click', showSaveModal);
            document.getElementById('btnBackToMenu').addEventListener('click', backToMenu);
            document.getElementById('btnDeleteSequence').addEventListener('click', deleteSequence);
            document.getElementById('btnSaveSequence').addEventListener('click', saveCurrentSequence);
            document.getElementById('btnSaveFile').addEventListener('click', saveAsFile);
            document.getElementById('btnLoadFile').addEventListener('click', () => {
                fileInput.value = ''; // Resetear para permitir cargar el mismo archivo múltiples veces
                fileInput.click();
            });
        
            // Configuración del input de archivo
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
        
        // Configurar evento de carga de archivo
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    if (file.type === 'application/json' || file.name.endsWith('.json')) {
                        loadFromFile(file);
                    } else {
                        alert('Por favor, selecciona un archivo JSON');
                    }
                }
            });
            // Configuración del player tool (añadir al DOMContentLoaded)
            document.getElementById('playerTool').addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('colorPicker').style.display = 'block';
            });

            document.getElementById('confirmColor').addEventListener('click', function() {
                const color = document.getElementById('playerColor').value;
                document.getElementById('colorPicker').style.display = 'none';
                createDraggableElement('player', null, color);
            });
                // Configuración de eventos de arrastre
                setupFieldDragEvents();
            });
            fieldContainer = document.getElementById('fieldContainer');
        //FUNCIONES DE GESTIÓN DE ACTIVIDADES
        function startNewActivity() {
        welcomeScreen.style.display = 'none';
        editorScreen.style.display = 'block';
        resetEditor();
    }

        function showLoadModal() {
            loadSavedActivities();
            loadModal.style.display = 'flex';
        }

        function showSaveModal() {
        saveModal.style.display = 'flex';
    }

        function backToMenu() {
        if (confirm('¿Estás seguro de volver al menú? Se perderán los cambios no guardados.')) {
            resetEditor(); // Limpia el editor antes de volver
            editorScreen.style.display = 'none';
            welcomeScreen.style.display = 'block';
        }
    }
        function resetEditor() {
        // Limpiar el campo visualmente
        fieldContainer.innerHTML = '';
        
        // Reiniciar variables globales
        elements = [];
        elementCounter = 0;
        currentSequence = 1;
        sequences = { 
            1: { 
                elements: {},
                name: 'Secuencia 1'
            } 
        };
        
        // Restablecer la UI
        sequenceTabs.innerHTML = '<div class="sequence-tab active" data-sequence="1">Secuencia 1</div>';
        document.getElementById('sequenceLog').innerHTML = '<div class="log-entry current-sequence">Secuencia 1: Edición actual</div>';
    }

    //FUNCIONES DE SECUENCIAS

        function addSequence() {
        const newSequenceNumber = Object.keys(sequences).length + 1;
        
        // Guardar el estado actual ANTES de crear la nueva secuencia
        saveCurrentSequenceState();  // <-- Añadir esta línea
        
        sequences[newSequenceNumber] = { elements: {} };
        currentSequence = newSequenceNumber;
        
        // Copiar las posiciones actuales a la nueva secuencia
        elements.forEach(el => {
            const element = document.getElementById(el.id);
            if (element) {
                sequences[newSequenceNumber].elements[el.id] = {
                    startX: parseInt(element.style.left) || 0,
                    startY: parseInt(element.style.top) || 0,
                    endX: parseInt(element.style.left) || 0,  // Inicialmente igual a startX/Y
                    endY: parseInt(element.style.top) || 0
                };
            }
        });
        
        updateSequenceTabs();
        updateSequenceLog();
    }

    function changeSequence(sequenceNumber) {
        if (isAnimating) return;
        
        // Guardar la secuencia actual antes de cambiar
        saveCurrentSequenceState();
        
        // Cambiar a la nueva secuencia
        currentSequence = parseInt(sequenceNumber);
        
        // Restaurar la nueva secuencia
        restoreSequenceState();
        
        // Actualizar la UI
        updateSequenceTabs();
        updateSequenceLog();
    }

    function deleteSequence() {
        const totalSequences = Object.keys(sequences).length;
        if (totalSequences === 1) {
            alert('Debe haber al menos una secuencia');
            return;
        }
        
        if (confirm(`¿Eliminar la secuencia ${currentSequence}?`)) {
            // Guardar el número de secuencia a eliminar
            const sequenceToDelete = currentSequence;
            
            // Crear un nuevo objeto de secuencias manteniendo los datos originales
            const newSequences = {};
            
            // Copiar todas las secuencias excepto la que queremos eliminar
            // manteniendo los datos intactos
            for (let i = 1; i <= totalSequences; i++) {
                if (i != sequenceToDelete) {
                    // Si está antes de la eliminada, conserva su número
                    if (i < sequenceToDelete) {
                        newSequences[i] = JSON.parse(JSON.stringify(sequences[i]));
                    } 
                    // Si está después de la eliminada, reduce su número en 1
                    else {
                        newSequences[i-1] = JSON.parse(JSON.stringify(sequences[i]));
                    }
                }
            }
            
            sequences = newSequences;
            
            // Ajustar la secuencia actual
            if (sequenceToDelete > Object.keys(sequences).length) {
                currentSequence = Object.keys(sequences).length; // Ir a la última si eliminamos la última
            } else {
                currentSequence = sequenceToDelete <= 1 ? 1 : sequenceToDelete - 1; // Ir a la anterior si es posible
            }
            
            updateSequenceTabs();
            updateSequenceLog();
            restoreSequenceState(); // Asegura que la visualización sea correcta
        }
    }

        function saveCurrentSequence() {
        saveCurrentSequenceState();
        updateSequenceLog();
        alert(`Secuencia ${currentSequence} guardada correctamente.`);
    }

    function saveCurrentSequenceState() {
        sequences[currentSequence].elements = {};
        elements.forEach(el => {
            const element = document.getElementById(el.id);
            if (element) {
                // Obtener posición en porcentajes (asegurarse que siempre esté en %)
                let x = parseFloat(element.style.left);
                let y = parseFloat(element.style.top);
                
                // Si no hay unidades (%), asumir que son píxeles y convertirlos a %
                if (isNaN(x) || isNaN(y)) {
                    const fieldRect = fieldContainer.getBoundingClientRect();
                    const elemRect = element.getBoundingClientRect();
                    x = ((elemRect.left - fieldRect.left) / fieldRect.width) * 100;
                    y = ((elemRect.top - fieldRect.top) / fieldRect.height) * 100;
                }
                
                sequences[currentSequence].elements[el.id] = {
                    startX: x,
                    startY: y,
                    endX: x,
                    endY: y
                };
            }
        });
    }
    function restoreSequenceState() {
        elements.forEach(el => {
            const element = document.getElementById(el.id);
            if (element && sequences[currentSequence].elements[el.id]) {
                const pos = sequences[currentSequence].elements[el.id];
                // Aplicar posición en porcentajes
                element.style.left = `${pos.startX}%`;
                element.style.top = `${pos.startY}%`;
            }
        });
    }

        function updateSequenceTabs() {
        sequenceTabs.innerHTML = '';
        Object.keys(sequences).forEach(seq => {
            const tab = document.createElement('div');
            tab.className = `sequence-tab ${seq == currentSequence ? 'active' : ''}`;
            tab.textContent = `Secuencia ${seq}`;
            tab.dataset.sequence = seq;
            tab.addEventListener('click', () => changeSequence(parseInt(seq)));
            sequenceTabs.appendChild(tab);
        });
    }

        function updateSequenceLog() {
        const log = document.getElementById('sequenceLog');
        log.innerHTML = '';
        Object.entries(sequences).forEach(([seqNum, sequence]) => {
            const entry = document.createElement('div');
            entry.className = `log-entry ${seqNum == currentSequence ? 'current-sequence' : ''}`;
            const moves = Object.entries(sequence.elements).map(([id, data]) => {
                const element = elements.find(el => el.id === id);
                const elementType = element ? element.type : 'Elemento eliminado';
                return `${elementType}: (${Math.round(data.startX)},${Math.round(data.startY)}) → (${Math.round(data.endX)},${Math.round(data.endY)})`;
            }).join('<br>');
            entry.innerHTML = `<strong>Secuencia ${seqNum}:</strong><br>${moves || 'Sin movimientos registrados'}`;
            log.appendChild(entry);
        });
    }

        //FUNCIONES DE ELEMENTOS Y DRAG AND DROP

        function createDraggableElement(type, customId = null, color = '#3498db') {
            const id = customId || `element-${++elementCounter}`;
            const element = document.createElement('img');
            element.className = 'element';
            element.id = id;
            element.dataset.type = type;

            // Posición inicial aleatoria en porcentajes
            const randomX = Math.floor(Math.random() * 80) + 10;
            const randomY = Math.floor(Math.random() * 80) + 10;

            element.style.left = `${randomX}%`;
            element.style.top = `${randomY}%`;
            element.style.transform = 'translate(-50%, -50%)';


            // Asignar imagen según tipo y color
            switch (type) {
                case 'ball':
                    element.src = "./pelota.png";
                    break;
                case 'cone':
                    element.src = "./cono.png";
                    break;
                case 'player':
                    element.src = generatePlayerSVG(color); // Usar el color proporcionado
                    break;
                case 'marker':
                    element.src = 'data:image/svg+xml;base64,...';
                    break;
            }

            // Eventos táctiles
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDragging(e);
            }, { passive: false });

            Object.keys(sequences).forEach(seq => {
                sequences[seq].elements[id] = {
                    startX: randomX,
                    startY: randomY,
                    endX: randomX,
                    endY: randomY
                };
            });

            elements.push({ id: id, type: type, color: type === 'player' ? color : null });
            fieldContainer.appendChild(element);
            return element;
        }

        function setupFieldDragEvents() {
            // Eventos para herramientas (solo arrastre para elementos que no son jugadores)
            document.querySelectorAll('.tool:not([data-type="player"])').forEach(tool => {
                tool.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    createDraggableElement(e.target.dataset.type);
                });
                tool.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    createDraggableElement(e.target.dataset.type);
                }, { passive: false });
            });

            // Eventos para el campo
            fieldContainer.addEventListener('mousedown', startDragging);
            fieldContainer.addEventListener('touchstart', startDragging, { passive: false });
            document.addEventListener('mousemove', dragElement);
            document.addEventListener('touchmove', dragElement, { passive: false });
            document.addEventListener('mouseup', stopDragging);
            document.addEventListener('touchend', stopDragging);
        }

        function startDragging(e) {
        e.preventDefault();
        if (e.target.classList.contains('element') && !isAnimating) {
            isDragging = true;
            selectedElement = e.target;
            selectedElementId = selectedElement.id;
            const coords = getClientCoordinates(e);
            const rect = selectedElement.getBoundingClientRect();
            const fieldRect = fieldContainer.getBoundingClientRect();
            sequences[currentSequence].elements[selectedElementId] = {
                startX: rect.left - fieldRect.left,
                startY: rect.top - fieldRect.top,
                endX: rect.left - fieldRect.left,
                endY: rect.top - fieldRect.top
            };
            offsetX = coords.clientX - rect.left;
            offsetY = coords.clientY - rect.top;
            selectedElement.style.cursor = 'grabbing';
        }
    }

    function dragElement(e) {
        if (isDragging && selectedElement) {
            e.preventDefault();
            const fieldRect = fieldContainer.getBoundingClientRect();
            const coords = getClientCoordinates(e);

            // Calcular posición en % relativa al campo
            const newX = ((coords.clientX - fieldRect.left) / fieldRect.width) * 100;
            const newY = ((coords.clientY - fieldRect.top) / fieldRect.height) * 100;

            // Limitar al área del campo (0% - 100%)
            const clampedX = Math.max(0, Math.min(newX, 100));
            const clampedY = Math.max(0, Math.min(newY, 100));

            selectedElement.style.left = `${clampedX}%`;
            selectedElement.style.top = `${clampedY}%`;

            // Guardar posición en secuencias (en %)
            sequences[currentSequence].elements[selectedElementId] = {
                startX: clampedX,
                startY: clampedY,
                endX: clampedX,
                endY: clampedY
            };
        }
    }
    function dragElement(e) {
        if (isDragging && selectedElement) {
            e.preventDefault();
            const fieldRect = fieldContainer.getBoundingClientRect();
            const coords = getClientCoordinates(e);

            // Calcular posición en % relativa al campo
            const newX = ((coords.clientX - fieldRect.left) / fieldRect.width) * 100;
            const newY = ((coords.clientY - fieldRect.top) / fieldRect.height) * 100;

            // Limitar al área del campo (0% - 100%)
            const clampedX = Math.max(0, Math.min(newX, 100));
            const clampedY = Math.max(0, Math.min(newY, 100));

            selectedElement.style.left = `${clampedX}%`;
            selectedElement.style.top = `${clampedY}%`;

            // Guardar posición en secuencias (en %)
            sequences[currentSequence].elements[selectedElementId] = {
                startX: clampedX,
                startY: clampedY,
                endX: clampedX,
                endY: clampedY
            };
        }
    }

        function stopDragging() {
        if (isDragging) {
            isDragging = false;
            if (selectedElement) {
                selectedElement.style.cursor = 'move';
                selectedElement = null;
                selectedElementId = null;
            }
        }
    }

        function getClientCoordinates(e) {
        if (e.touches && e.touches.length > 0) {
            return { clientX: e.touches[0].clientX, clientY: e.touches[0].clientY };
        }
        return { clientX: e.clientX, clientY: e.clientY };
    }

        //FUNCIONES DE ANIMACIÓN Y GRABACIÓN

        async function playAllSequences() {
        if (isAnimating) return;
        isAnimating = true;
        for (const [seqNum, sequence] of Object.entries(sequences)) {
            await animateSequence(sequence);
        }
        isAnimating = false;
    }

    async function animateSequence(sequence) {
        return new Promise(resolve => {
            const log = document.getElementById('sequenceLog');
            log.innerHTML = '<div class="log-entry current-sequence">Reproduciendo secuencia...</div>';
            const originalPositions = new Map();
            
            // Guardar posiciones originales en porcentajes
            elements.forEach(el => {
                const element = document.getElementById(el.id);
                originalPositions.set(el.id, { 
                    x: element.style.left, 
                    y: element.style.top 
                });
            });

            // Aplicar movimientos usando porcentajes
            Object.entries(sequence.elements).forEach(([id, movement]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.transition = 'all 1s ease-in-out';
                    element.style.left = `${movement.endX}%`;
                    element.style.top = `${movement.endY}%`;
                }
            });

            setTimeout(() => {
                log.innerHTML = Object.entries(sequence.elements).map(([id, movement]) => {
                    const element = elements.find(el => el.id === id);
                    return `Elemento ${element?.type || 'desconocido'} movido a (${Math.round(movement.endX)}%, ${Math.round(movement.endY)}%)`;
                }).join('<br>');
            }, 500);

            setTimeout(() => {
                // Restaurar posiciones originales
                elements.forEach(el => {
                    const element = document.getElementById(el.id);
                    if (element) {
                        element.style.transition = 'none';
                        const original = originalPositions.get(el.id);
                        element.style.left = original.x;
                        element.style.top = original.y;
                    }
                });
                resolve();
            }, 1100);
        });
    }
        async function recordSequence() {
        try {
            if (typeof RecordRTC === 'undefined') throw new Error('RecordRTC no se cargó correctamente. Recarga la página.');
            alert("La grabación comenzará en 3 segundos. Por favor no interactúe con la página.");
            await new Promise(resolve => setTimeout(resolve, 3000));
            const fieldContainer = document.getElementById('fieldContainer');
            const canvas = await html2canvas(fieldContainer, { scale: 0.8, logging: false, useCORS: true, allowTaint: false });
            const stream = canvas.captureStream(15);
            mediaRecorder = new RecordRTC(stream, { type: 'video', mimeType: 'video/webm;codecs=vp9', bitsPerSecond: 1500000, frameRate: 15 });
            mediaRecorder.startRecording();
            await playAllSequences();
            setTimeout(() => {
                mediaRecorder.stopRecording(() => {
                    const blob = mediaRecorder.getBlob();
                    downloadVideo(blob);
                    stream.getTracks().forEach(track => track.stop());
                });
            }, 1000);
        } catch (error) {
            console.error('Error en grabación:', error);
            alert(`Error al grabar: ${error.message}`);
        }
    }

        function downloadVideo(blob) {
        try {
            const filename = `entrenamiento_${new Date().toISOString().slice(0, 19)}.webm`;
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 1000);
        } catch (error) {
            console.error('Error al descargar:', error);
            alert('Error al generar el archivo de video');
        }
    }

        //FUNCIONES DE IMPORTACIÓN/EXPORTACIÓN

        function saveAsFile() {
            // Primero guardamos el estado actual de la secuencia
            saveCurrentSequenceState();

            // Preparamos los datos para guardar
            const activityData = {
                name: "Entrenamiento_" + new Date().toISOString().slice(0, 10),
                elements: elements.map(el => {
                    const element = document.getElementById(el.id);
                    // Obtenemos la posición actual del elemento en el DOM
                    const x = element ? parseFloat(element.style.left) || 50 : 50;
                    const y = element ? parseFloat(element.style.top) || 50 : 50;
                    
                    return {
                        id: el.id,
                        type: el.type,
                        color: el.color || null,
                        x: x,
                        y: y
                    };
                }),
                sequences: sequences,
                timestamp: Date.now()
            };

            // Convertir todas las posiciones a porcentajes antes de guardar
            Object.keys(activityData.sequences).forEach(seq => {
                Object.keys(activityData.sequences[seq].elements).forEach(elId => {
                    const el = activityData.sequences[seq].elements[elId];
                    // Asegurar que son números
                    el.startX = parseFloat(el.startX);
                    el.startY = parseFloat(el.startY);
                    el.endX = parseFloat(el.endX);
                    el.endY = parseFloat(el.endY);
                });
            });

            // Crear y descargar el archivo
            const blob = new Blob([JSON.stringify(activityData)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `entrenamiento_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function loadFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    loadActivity('Archivo cargado', data);
                } catch(error) {
                    alert('Error al cargar archivo: Formato inválido');
                }
            };
            reader.readAsText(file);
        }

    //FUNCIONES DE IndexedDB

        function initDB() {
        return new Promise((resolve, reject) => {
            
            const request = indexedDB.open('FootballTrainingDB', 1);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('activities')) {
                    db.createObjectStore('activities', { keyPath: 'name' });
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject('Error al abrir la base de datos');
        });
    }

        function loadSavedActivities() {
        savedActivitiesList.innerHTML = '';
        initDB().then(db => {
            const transaction = db.transaction(['activities'], 'readonly');
            const store = transaction.objectStore('activities');
            const request = store.getAll();
            request.onsuccess = () => {
                const activities = request.result;
                if (activities.length === 0) {
                    savedActivitiesList.innerHTML = '<p>No hay actividades guardadas.</p>';
                    return;
                }
                activities.sort((a, b) => b.timestamp - a.timestamp);
                activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    activityItem.textContent = activity.name;
                    activityItem.addEventListener('click', () => {
                        loadActivity(activity.name, activity);
                        loadModal.style.display = 'none';
                    });
                    savedActivitiesList.appendChild(activityItem);
                });
            };
            request.onerror = (event) => {
                console.error('Error al cargar actividades:', event.target.error);
                savedActivitiesList.innerHTML = '<p>Error al cargar actividades guardadas.</p>';
            };
        }).catch(error => {
            console.error('Error en la base de datos:', error);
            savedActivitiesList.innerHTML = '<p>Error al acceder a la base de datos.</p>';
        });
    }

    function deleteActivity(activityName) {
            initDB().then(db => {
            const transaction = db.transaction(['activities'], 'readwrite');
            const store = transaction.objectStore('activities');
            const request = store.delete(activityName);
            request.onsuccess = () => {
                alert(`Actividad "${activityName}" eliminada correctamente.`);
                loadSavedActivities();
            };
            request.onerror = (event) => {
                console.error('Error al eliminar actividad:', event.target.error);
                alert('Error al eliminar la actividad.');
            };
        }).catch(error => {
            console.error('Error en la base de datos:', error);
            alert('Error al acceder a la base de datos.');
        });
    }
    function loadActivity(name, data) {
        try {
            // Limpiar estado actual
            resetEditor();
            
            // Verificar y normalizar datos cargados
            if (!data.sequences || typeof data.sequences !== 'object') {
                throw new Error("Datos de secuencias inválidos");
            }
            
            // Cargar elementos
            if (data.elements && Array.isArray(data.elements)) {
                data.elements.forEach(el => {
                    const element = createDraggableElement(el.type, el.id, el.color);
                    // Posición inicial desde datos o valores por defecto
                    element.style.left = `${el.x || 50}%`;
                    element.style.top = `${el.y || 50}%`;
                });
            }
            
            // Cargar secuencias (con validación)
            sequences = {};
            Object.keys(data.sequences).forEach(seq => {
                sequences[seq] = { elements: {} };
                Object.keys(data.sequences[seq].elements).forEach(elId => {
                    const elData = data.sequences[seq].elements[elId];
                    sequences[seq].elements[elId] = {
                        startX: parseFloat(elData.startX) || 50,
                        startY: parseFloat(elData.startY) || 50,
                        endX: parseFloat(elData.endX) || 50,
                        endY: parseFloat(elData.endY) || 50
                    };
                });
            });
            
            // Restaurar primera secuencia
            currentSequence = 1;
            restoreSequenceState();
            updateSequenceTabs();
            updateSequenceLog();
            
            // Mostrar editor
            welcomeScreen.style.display = 'none';
            editorScreen.style.display = 'block';
        } catch (error) {
            console.error("Error al cargar actividad:", error);
            alert(`Error al cargar la actividad: ${error.message}`);
        }
    }

    function generatePlayerSVG(color) {
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50">
                <circle cx="25" cy="15" r="10" fill="${color}"/>
                <path d="M25 25c-7.5 0-15 3-15 8v12h30V33c0-5-7.5-8-15-8z" fill="${color}"/>
            </svg>
        `;
        return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
    }
    </script>
</body>
</html>
    
    </script>
</body>
